---
- name: Server configuration
  hosts: all
  become: true

  tasks:
    - name: Ensure /opt/myapp is created
      file:
        path: /opt/myapp
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0750'

    - name: Install and configure Docker
      block:
        - name: Download Docker install script
          get_url:
            url: https://get.docker.com
            dest: /tmp/get-docker.sh
            mode: '0755'

        - name: Execute Docker install script
          command: /tmp/get-docker.sh
          args:
            creates: /usr/bin/docker

        - name: Clean up
          file:
            path: /tmp/get-docker.sh
            state: absent

    - name: Ensure Docker service is enabled and started
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Add vagrant user to docker group
      ansible.builtin.user:
        name: vagrant
        groups: docker
        append: yes

    - name: Copy docker-compose.yml file to VM
      ansible.builtin.copy:
        src: docker-compose.yml
        dest: /opt/myapp/
        mode: "0644"

    - name: Start Docker Compose Services
      command: docker compose -f /opt/myapp/docker-compose.yml up -d
      args:
        chdir: /opt/myapp/
